#!/usr/bin/env bash

set -e

DIRNAME=$(dirname $0)
COOKIE_PATH="$DIRNAME/cookie.jar"
CURL_CMD="curl --location --silent --cookie $COOKIE_PATH --cookie-jar $COOKIE_PATH"

source "$DIRNAME/settings.ini"

declare -A ERROR_MSGS
ERROR_MSGS[1]="Не могу получить productId!"
ERROR_MSGS[2]="Не могу переключить тариф!"

OFFER=$OFFER_NORM
if [[ $1 = "min" ]]; then
    OFFER=$OFFER_MIN
fi

if [[ ! "$ERR_HANDLER" ]]; then
    ERR_HANDLER="echo $1"
fi

function exitHandler() {
    rm "$COOKIE_PATH"
    if [[ $1 != 0 ]]; then
        eval "$ERR_HANDLER" "${ERROR_MSGS[$1]}"
    fi
}

trap 'exitHandler $?' EXIT

# # #

$CURL_CMD\
    -d "IDToken1=$LOGIN"\
    -d "IDToken2=$PASSWORD"\
    -d "goto=https://my.yota.ru/selfcare/loginSuccess"\
    -d "org=customer"\
    https://login.yota.ru/UI/Login > /dev/null

productId=$($CURL_CMD https://my.yota.ru/selfcare/devices | grep -Eo 'name="product" value="[0-9]+"' | grep -Eo '[0-9]+')

[[ -z $productId ]] && exit 1

# TODO: всамоделешнее подтверждение переключения
isOfferChanged=$($CURL_CMD\
    -d "product=$productId"\
    -d "offerCode=$OFFER"\
    -d "areOffersAvailable=false"\
    -d "status=custom"\
    -d "isSlot=false"\
    -d "currentDevice=1"\
    -d "isDisablingAutoprolong=false"\
    https://my.yota.ru/selfcare/devices/changeOffer | grep -o "offerDisabled")

[[ -z $isOfferChanged ]] && exit 2

exit 0
